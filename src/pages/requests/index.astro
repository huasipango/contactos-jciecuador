---
import Layout from '../../layouts/Layout.astro';
import RequestForm from '../../components/RequestForm.astro';
import RequestList from '../../components/RequestList.astro';
import Alert from '../../components/ui/Alert.astro';
import { getSessionUser } from '../../utils/auth';
import { getAuthUrl, generateOauthState } from '../../utils/googleAdmin';

export const prerender = false;

const user = await getSessionUser(Astro);
if (!user) {
  const state = generateOauthState();
  Astro.cookies.set('oauth_state', state, {
    path: '/',
    secure: true,
    httpOnly: true,
    sameSite: 'lax',
    maxAge: 600
  });
  const authUrl = await getAuthUrl(state);
  return Astro.redirect(authUrl);
}
---

<Layout title="Gestión de correos">
  <main class="container mx-auto px-4 py-8 space-y-4">
    <Alert variant="info">
      <h1 class="text-2xl font-bold text-foreground">Gestión de cuentas de correo</h1>
      <p class="text-sm text-foreground mt-1">
        Rol actual: <span class="font-semibold">{user.role}</span> ({user.email})
      </p>
      <p class="text-sm text-foreground mt-1">
        Flujo semi-automático activo: teléfono y recuperación de contraseña en automático; altas y bajas con aprobación.
      </p>
    </Alert>
    <RequestForm />
    <RequestList />
  </main>
</Layout>
