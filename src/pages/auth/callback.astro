---
import { getTokenFromCode } from '../../utils/googleAdmin';

// Asegura que la p치gina se renderiza en el servidor
export const prerender = false;

const code = Astro.url.searchParams.get('code');
const error = Astro.url.searchParams.get('error');

if (error) {
  console.error('OAuth error:', error);
  return Astro.redirect('/?error=auth');
}

if (!code) {
  return Astro.redirect('/');
}

try {
  const tokens = await getTokenFromCode(code);
  if (tokens.access_token) {
    // Configurar la cookie con opciones m치s seguras
    Astro.cookies.set('access_token', tokens.access_token, {
      path: '/',
      secure: true,
      sameSite: 'lax',
      maxAge: 3600 // 1 hora
    });
    
    return Astro.redirect('/?auth=success');
  }
} catch (error) {
  console.error('Error getting tokens:', error);
  return Astro.redirect('/?error=token');
}

return Astro.redirect('/?error=unknown');
---

<!DOCTYPE html>
<html>
<head>
  <title>Procesando autenticaci칩n...</title>
</head>
<body>
  <p>Procesando autenticaci칩n, por favor espere...</p>
</body>
</html> 