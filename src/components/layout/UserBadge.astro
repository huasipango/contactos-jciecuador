---
interface Props {
  displayName: string;
  email: string;
  roleLabel: string;
  photoUrl: string | null;
}

const { displayName, email, roleLabel, photoUrl } = Astro.props;

const initials = displayName
  .split(' ')
  .slice(0, 2)
  .map((w) => w.charAt(0).toUpperCase())
  .join('');
---

<div class="relative" id="user-badge-wrapper">
  <button
    id="user-badge-toggle"
    class="flex items-center gap-2.5 rounded-lg px-2 py-1.5 transition-colors hover:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
    aria-haspopup="true"
    aria-expanded="false"
  >
    {photoUrl ? (
      <img
        src={photoUrl}
        alt={displayName}
        class="h-8 w-8 rounded-full object-cover ring-2 ring-primary/20"
        referrerpolicy="no-referrer"
      />
    ) : (
      <span class="flex h-8 w-8 items-center justify-center rounded-full bg-primary text-xs font-semibold text-primary-foreground ring-2 ring-primary/20">
        {initials}
      </span>
    )}
    <div class="hidden text-left md:block">
      <p class="text-sm font-medium leading-tight text-foreground">{displayName}</p>
      <p class="text-[11px] leading-tight text-muted-foreground">{roleLabel}</p>
    </div>
    <svg class="hidden h-4 w-4 text-muted-foreground md:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div
    id="user-dropdown"
    class="absolute right-0 top-full z-50 mt-1 hidden w-64 rounded-lg border border-border bg-popover p-1 shadow-lg"
    role="menu"
  >
    <div class="border-b border-border px-3 py-2.5">
      <p class="text-sm font-medium text-popover-foreground">{displayName}</p>
      <p class="text-xs text-muted-foreground">{email}</p>
      <span class="mt-1 inline-block rounded-full bg-primary/10 px-2 py-0.5 text-[11px] font-medium text-primary">
        {roleLabel}
      </span>
    </div>
    <div class="py-1">
      <a
        href="/auth/logout"
        class="flex w-full items-center gap-2 rounded-md px-3 py-2 text-sm text-destructive transition-colors hover:bg-destructive/10"
        role="menuitem"
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        Cerrar sesi√≥n
      </a>
    </div>
  </div>
</div>

<script>
  const toggle = document.getElementById('user-badge-toggle');
  const dropdown = document.getElementById('user-dropdown');
  const wrapper = document.getElementById('user-badge-wrapper');

  toggle?.addEventListener('click', () => {
    const isOpen = !dropdown?.classList.contains('hidden');
    dropdown?.classList.toggle('hidden');
    toggle.setAttribute('aria-expanded', String(!isOpen));
  });

  document.addEventListener('click', (e) => {
    if (wrapper && !wrapper.contains(e.target as Node)) {
      dropdown?.classList.add('hidden');
      toggle?.setAttribute('aria-expanded', 'false');
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      dropdown?.classList.add('hidden');
      toggle?.setAttribute('aria-expanded', 'false');
    }
  });
</script>
