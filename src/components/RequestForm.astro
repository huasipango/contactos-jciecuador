<div class="bg-card text-card-foreground rounded-lg border border-border p-4">
  <h2 class="text-lg font-semibold mb-4 text-foreground">Nueva solicitud</h2>
  <form id="requestForm" class="grid md:grid-cols-2 gap-3">
    <label class="block text-sm">
      <span class="text-foreground">Tipo</span>
      <select id="reqType" class="mt-1 w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors">
        <option value="create_account">Nueva cuenta</option>
        <option value="update_phone">Actualizar teléfono</option>
        <option value="reset_password">Recuperar contraseña</option>
        <option value="delete_account">Eliminar cuenta</option>
      </select>
    </label>

    <label class="block text-sm">
      <span class="text-foreground">Unidad organizativa</span>
      <input id="ou" class="mt-1 w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm placeholder:text-muted-foreground focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors" placeholder="/JCI Ecuador/..." />
    </label>

    <label class="block text-sm">
      <span class="text-foreground">Correo objetivo</span>
      <input id="targetEmail" class="mt-1 w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm placeholder:text-muted-foreground focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors" placeholder="usuario@jciecuador.com" />
    </label>

    <label class="block text-sm">
      <span class="text-foreground">Teléfono</span>
      <input id="phone" class="mt-1 w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm placeholder:text-muted-foreground focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors" placeholder="+593..." />
    </label>

    <label class="block text-sm">
      <span class="text-foreground">Nombres</span>
      <input id="givenName" class="mt-1 w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm placeholder:text-muted-foreground focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors" placeholder="Dos nombres" />
    </label>

    <label class="block text-sm">
      <span class="text-foreground">Apellidos</span>
      <input id="familyName" class="mt-1 w-full h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm placeholder:text-muted-foreground focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors" placeholder="Dos apellidos" />
    </label>

    <label class="md:col-span-2 block text-sm">
      <span class="text-foreground">Motivo</span>
      <textarea id="reason" rows="3" class="mt-1 w-full px-3 py-2 rounded-md border border-input bg-background text-foreground text-sm placeholder:text-muted-foreground focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors resize-y"></textarea>
    </label>

    <label class="md:col-span-2 inline-flex items-center gap-2 text-sm text-foreground">
      <input id="dryRun" type="checkbox" class="w-4 h-4 rounded-sm border border-input accent-primary" />
      Simular (dry run)
    </label>

    <div class="md:col-span-2 flex gap-2">
      <button type="submit" class="inline-flex items-center justify-center h-10 px-6 rounded-md bg-primary text-primary-foreground font-medium text-sm hover:bg-primary/90 transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ring">Guardar solicitud</button>
      <button type="button" id="clearForm" class="inline-flex items-center justify-center h-10 px-6 rounded-md border border-input bg-background text-foreground font-medium text-sm hover:bg-muted transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ring">Limpiar</button>
    </div>
  </form>
  <p id="requestFormFeedback" class="mt-3 text-sm"></p>
</div>

<script>
  const form = document.getElementById('requestForm') as HTMLFormElement | null;
  const feedback = document.getElementById('requestFormFeedback') as HTMLParagraphElement | null;
  const clearButton = document.getElementById('clearForm') as HTMLButtonElement | null;

  function setFeedback(message: string, isError = false) {
    if (!feedback) return;
    feedback.textContent = message;
    feedback.className = `mt-3 text-sm ${isError ? 'text-destructive' : 'text-accent'}`;
  }

  function clearAll() {
    (document.getElementById('reqType') as HTMLSelectElement).value = 'create_account';
    (document.getElementById('ou') as HTMLInputElement).value = '';
    (document.getElementById('targetEmail') as HTMLInputElement).value = '';
    (document.getElementById('phone') as HTMLInputElement).value = '';
    (document.getElementById('givenName') as HTMLInputElement).value = '';
    (document.getElementById('familyName') as HTMLInputElement).value = '';
    (document.getElementById('reason') as HTMLTextAreaElement).value = '';
    (document.getElementById('dryRun') as HTMLInputElement).checked = false;
  }

  clearButton?.addEventListener('click', clearAll);

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    setFeedback('Guardando solicitud...');
    const payload = {
      type: (document.getElementById('reqType') as HTMLSelectElement).value,
      organizationalUnit: (document.getElementById('ou') as HTMLInputElement).value,
      dryRun: (document.getElementById('dryRun') as HTMLInputElement).checked,
      payload: {
        targetEmail: (document.getElementById('targetEmail') as HTMLInputElement).value,
        phone: (document.getElementById('phone') as HTMLInputElement).value,
        givenName: (document.getElementById('givenName') as HTMLInputElement).value,
        familyName: (document.getElementById('familyName') as HTMLInputElement).value,
        orgUnitPath: (document.getElementById('ou') as HTMLInputElement).value,
        reason: (document.getElementById('reason') as HTMLTextAreaElement).value
      }
    };

    try {
      const response = await fetch('/api/requests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      if (!response.ok) {
        setFeedback(data.error || 'No se pudo guardar la solicitud', true);
        return;
      }
      setFeedback('Solicitud creada correctamente.');
      clearAll();
      window.dispatchEvent(new CustomEvent('requests:reload'));
    } catch (error) {
      setFeedback('Error al guardar solicitud', true);
    }
  });
</script>
