---
import { type User, type OrganizationalUnit } from '../types';

interface Props {
  users: User[];
  orgUnits: OrganizationalUnit[];
}

const { users } = Astro.props;
const uniqueOUs = [...new Set(users.map((user) => user.organizationalUnitName || user.organizationalUnit).filter(Boolean))].sort();

---

<div class="space-y-4">
  <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
    <input
      type="text"
      id="searchInput"
      placeholder="Buscar por nombre, correo o OOLL..."
      class="w-full md:w-1/2 h-10 px-4 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors"
    />
    <select
      id="ouFilter"
      class="w-full md:w-auto h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors"
    >
      <option value="">Todas las OOLL</option>
      {uniqueOUs.map((ou) => (
        <option value={ou}>{ou}</option>
      ))}
    </select>
    <select
      id="sortBy"
      class="w-full md:w-auto h-10 px-3 rounded-md border border-input bg-background text-foreground text-sm focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors"
    >
      <option value="name">Ordenar: nombre</option>
      <option value="last_login_desc">Último acceso (más reciente)</option>
      <option value="last_login_asc">Último acceso (más antiguo)</option>
    </select>
    <div class="flex items-center space-x-2 w-full md:w-auto">
      <label class="text-sm text-muted-foreground">Mostrar</label>
      <select
        id="itemsPerPage"
        class="h-10 px-2 rounded-md border border-input bg-background text-foreground text-sm focus:outline-2 focus:outline-ring focus:outline-offset-0 transition-colors"
      >
        <option value="25" selected>25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span class="text-sm text-muted-foreground">registros</span>
    </div>
  </div>

  <div class="overflow-x-auto rounded-lg border border-border">
    {users.length === 0 ? (
      <div class="p-4 text-center text-muted-foreground">
        No se encontraron usuarios.
      </div>
    ) : (
      <table class="min-w-full divide-y divide-border">
        <thead class="bg-muted/50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider w-16">
              #
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Nombre
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Correo Electrónico
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Unidad Organizativa
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Último Acceso
            </th>
            <th class="px-6 py-3 text-center text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Acciones
            </th>
          </tr>
        </thead>
        <tbody id="tableBody" class="bg-card divide-y divide-border">
          {users.map((user, index) => (
            <tr
              class="hover:bg-muted/30 transition-colors cursor-pointer"
              data-email={user.email}
              data-name={user.fullName}
              data-ou={user.organizationalUnitName || user.organizationalUnit}
              data-last-login={user.lastLoginTime || ''}
            >
              <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                {index + 1}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-foreground">
                {user.fullName}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                {user.email}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                {user.organizationalUnitName || user.organizationalUnit}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                {user.lastLoginTime ? new Date(user.lastLoginTime).toLocaleDateString('es-EC') : 'Sin acceso registrado'}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                <button
                  class="copy-button inline-flex items-center justify-center h-8 px-3 rounded-md bg-primary text-primary-foreground font-medium text-xs hover:bg-primary/90 transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ring"
                  data-email={user.email}
                >
                  COPIAR CORREO
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    )}
  </div>

  <div class="flex items-center justify-between mt-4">
    <div class="text-sm text-muted-foreground">
      Mostrando <span id="startIndex">0</span> a <span id="endIndex">0</span> de <span id="totalItems">0</span> registros
    </div>
    <div class="flex gap-2">
      <button
        id="prevPage"
        class="inline-flex items-center justify-center h-10 px-4 text-sm font-medium border border-input bg-background text-foreground rounded-md hover:bg-muted transition-colors disabled:opacity-50 disabled:pointer-events-none"
        disabled
      >
        Anterior
      </button>
      <button
        id="nextPage"
        class="inline-flex items-center justify-center h-10 px-4 text-sm font-medium border border-input bg-background text-foreground rounded-md hover:bg-muted transition-colors disabled:opacity-50 disabled:pointer-events-none"
        disabled
      >
        Siguiente
      </button>
    </div>
  </div>

</div>

<script>
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const ouFilter = document.getElementById('ouFilter') as HTMLSelectElement;
  const sortBy = document.getElementById('sortBy') as HTMLSelectElement;
  const itemsPerPageSelect = document.getElementById('itemsPerPage') as HTMLSelectElement;
  const tableBody = document.getElementById('tableBody') as HTMLTableSectionElement | null;
  const prevPageBtn = document.getElementById('prevPage') as HTMLButtonElement;
  const nextPageBtn = document.getElementById('nextPage') as HTMLButtonElement;
  const startIndexSpan = document.getElementById('startIndex') as HTMLSpanElement;
  const endIndexSpan = document.getElementById('endIndex') as HTMLSpanElement;
  const totalItemsSpan = document.getElementById('totalItems') as HTMLSpanElement;

  let currentPage = 1;
  let pageSize = 25;
  let filteredRows: HTMLTableRowElement[] = [];
  const allRows = tableBody ? (Array.from(tableBody.querySelectorAll('tr')) as HTMLTableRowElement[]) : [];

  function updatePagination() {
    const totalItems = filteredRows.length;
    const totalPages = Math.ceil(totalItems / pageSize);
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalItems);

    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage === totalPages;

    startIndexSpan.textContent = totalItems === 0 ? '0' : (startIndex + 1).toString();
    endIndexSpan.textContent = endIndex.toString();
    totalItemsSpan.textContent = totalItems.toString();

    allRows.forEach(row => row.style.display = 'none');
    filteredRows.slice(startIndex, endIndex).forEach((row, idx) => {
      row.style.display = '';
      const numberCell = row.querySelector('td:first-child');
      if (numberCell) {
        numberCell.textContent = (startIndex + idx + 1).toString();
      }
    });
  }

  function filterTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedOu = (ouFilter?.value || '').toLowerCase();
    const sortValue = sortBy?.value || 'name';

    filteredRows = allRows.filter((row) => {
      const name = (row.dataset.name || '').toLowerCase();
      const email = (row.dataset.email || '').toLowerCase();
      const ou = (row.dataset.ou || '').toLowerCase();
      const queryMatches = name.includes(searchTerm) || email.includes(searchTerm) || ou.includes(searchTerm);
      const ouMatches = !selectedOu || ou === selectedOu;
      return queryMatches && ouMatches;
    });

    filteredRows.sort((rowA, rowB) => {
      if (sortValue === 'last_login_desc' || sortValue === 'last_login_asc') {
        const aDate = rowA.dataset.lastLogin ? new Date(rowA.dataset.lastLogin).getTime() : 0;
        const bDate = rowB.dataset.lastLogin ? new Date(rowB.dataset.lastLogin).getTime() : 0;
        return sortValue === 'last_login_desc' ? bDate - aDate : aDate - bDate;
      }
      return (rowA.dataset.name || '').localeCompare(rowB.dataset.name || '');
    });

    currentPage = 1;
    updatePagination();
  }

  function showRowFeedback(row: HTMLTableRowElement) {
    row.classList.add('bg-accent/20');
    setTimeout(() => {
      row.classList.remove('bg-accent/20');
    }, 200);
  }

  searchInput?.addEventListener('input', filterTable);
  ouFilter?.addEventListener('change', filterTable);
  sortBy?.addEventListener('change', filterTable);

  itemsPerPageSelect?.addEventListener('change', () => {
    pageSize = parseInt(itemsPerPageSelect.value);
    currentPage = 1;
    updatePagination();
  });

  prevPageBtn?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      updatePagination();
    }
  });

  nextPageBtn?.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredRows.length / pageSize);
    if (currentPage < totalPages) {
      currentPage++;
      updatePagination();
    }
  });

  document.querySelectorAll('.copy-button').forEach(button => {
    button.addEventListener('click', async (e) => {
      e.stopPropagation();
      const email = (button as HTMLElement).getAttribute('data-email') || '';

      try {
        await navigator.clipboard.writeText(email);
        const btn = button as HTMLButtonElement;
        const originalText = btn.textContent;
        btn.textContent = '¡COPIADO!';
        btn.classList.remove('bg-primary', 'hover:bg-primary/90');
        btn.classList.add('bg-accent', 'hover:bg-accent/90');

        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('bg-accent', 'hover:bg-accent/90');
          btn.classList.add('bg-primary', 'hover:bg-primary/90');
        }, 2000);
      } catch (err) {
        console.error('Error al copiar:', err);
      }
    });
  });

  document.querySelectorAll('tbody tr').forEach((row) => {
    row.addEventListener('click', async (e) => {
      if (!(e.target as HTMLElement).closest('.copy-button')) {
        const email = row.getAttribute('data-email') || '';
        try {
          await navigator.clipboard.writeText(email);
          showRowFeedback(row as HTMLTableRowElement);

          const button = row.querySelector('.copy-button') as HTMLButtonElement;
          if (button) {
            const originalText = button.textContent;
            button.textContent = '¡COPIADO!';
            button.classList.remove('bg-primary', 'hover:bg-primary/90');
            button.classList.add('bg-accent', 'hover:bg-accent/90');

            setTimeout(() => {
              button.textContent = originalText;
              button.classList.remove('bg-accent', 'hover:bg-accent/90');
              button.classList.add('bg-primary', 'hover:bg-primary/90');
            }, 2000);
          }
        } catch (err) {
          console.error('Error al copiar:', err);
        }
      }
    });
  });

  filteredRows = allRows;
  updatePagination();
</script>
